# FreeBSD 2007 年 4-6 月状态报告

- 原文链接：<https://www.freebsd.org/status/report-2007-04-2007-06.html>

# 介绍

本报告涵盖了 2007 年 4 月至 6 月期间与 FreeBSD 相关的项目。又是一个令人激动的季度。5 月，我们在 [BSDCan](http://www.bsdcan.org/2007/) 举办了迄今为止规模最大的一次开发者峰会，25 名谷歌编程之夏学生开始了[他们的项目](http://www.freebsd.org/projects/summerofcode-2007.html)——进展报告请见下文，最后，7.0 版本发布周期已于三周前开始。

如果你对 FreeBSD 7.0 的新功能感兴趣，我们建议阅读 Ivan Voras 的精彩总结：[http://ivoras.sharanet.org/freebsd/freebsd7.html](http://ivoras.sharanet.org/freebsd/freebsd7.html)，当然还有这些报告。

下一次 BSD 社区的聚会将于 9 月 14 日至 15 日在[哥本哈根的 EuroBSDCon](http://2007.eurobsdcon.org/)举行。有关会议和开发者峰会的更多细节请参阅下面的报告。

感谢所有报告者的出色工作！希望你喜欢阅读。

# [Google Summer of Code](https://www.freebsd.org/status/report-2007-04-2007-06.html#Google-summer-of-code)

## [FreeBSD 的 GUI 审计分析工具](https://www.freebsd.org/status/report-2007-04-2007-06.html#A-GUI-audit-analyzer-for-FreeBSD)

| 链接 |
| ---- |
|      |

联系人: Dongmei Liu \<[ldm@ercist.iscas.ac.cn](mailto:ldm@ercist.iscas.ac.cn)\>

该项目旨在为 FreeBSD 提供一个 GUI 审计日志分析工具。参考 Ethereal/Wireshark 数据包解析引擎及其框架来查看和解析审计日志。

### 待完成任务：

1. 使用 GTK2.0 框架构建 GUI，包括菜单栏、工具栏、列表视图和树视图。
2. 在列表视图和树视图中解析并显示审计日志的尾部文件。
3. 实时捕获审计日志并解析并在列表视图和树视图中显示。
4. 添加过滤机制。
5. 添加统计机制。
6. 远程审计日志分析机制。

## [Apple 的 MacBook 在 FreeBSD 上](https://www.freebsd.org/status/report-2007-04-2007-06.html#Apple's-MacBook-on-FreeBSD)

| 链接 |
| ------- |
| [P4 仓库](http://repoman.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/soc2007/rpaulo%2dmacbook/ "http://repoman.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/soc2007/rpaulo%2dmacbook/")      |
| [wiki 页面](http://wiki.freebsd.org/AppleMacbook "http://wiki.freebsd.org/AppleMacbook")      |

联系方式：Rui Paulo \<[rpaulo@FreeBSD.org](mailto:rpaulo@FreeBSD.org)\>

Apple 的 MacBook 电脑设计精美，具有其他笔记本电脑没有的独特功能。虽然 Mac OS X 是一个很好的操作系统，但 UNIX 用户（像我）更喜欢运行 FreeBSD 等操作系统。该项目旨在为 FreeBSD 提供 bug 修复和新驱动程序，以帮助在该平台上运行这个操作系统。

### 待办事项：

1. 为触控板、键盘、遥控器红外接收器、蓝牙编写驱动程序或修复相关问题。
2. 修复重启、停机、挂起/恢复等问题。

---

## [BSD Bintools 项目](https://www.freebsd.org/status/report-2007-04-2007-06.html#BSD-Bintools-project)

| 链接 |
| ------- |
|       |

联系方式：Kai Wang \<[kaiw27@gmail.com](mailto:kaiw27@gmail.com)\>

ar(1)（包括 ranlib）的基本实现已经完成，并可在 Perforce 仓库中获得。目前，它提供了 ar(1) 应具有的所有主要功能，并且基于 libarchive 和 libelf 库，因此预计它的结构会比 GPL 版本更简单且更好。项目的下一步工作是进行详细的测试并添加其他功能。

---

## [分布式日志守护进程](https://www.freebsd.org/status/report-2007-04-2007-06.html#Distributed-Logging-Daemon)

| 链接 |
| ------- |
| [项目设计说明](http://docs.freebsd.org/cgi/getmsg.cgi?fetch=232192+0+/usr/local/www/db/text/2007/freebsd-hackers/20070527.freebsd-hackers "http://docs.freebsd.org/cgi/getmsg.cgi?fetch=232192+0+/usr/local/www/db/text/2007/freebsd-hackers/20070527.freebsd-hackers")      |
| [项目托管的 Perforce 仓库](http://perforce.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/soc2007/karma%5faudit/dlog&HIDEDEL=NO "http://perforce.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/soc2007/karma%5faudit/dlog&HIDEDEL=NO")      |

联系方式：Alexey Mikhailov \<[karma@FreeBSD.org](mailto:karma@FreeBSD.org)\>
联系方式：Bjoern Zeeb \<[bz@FreeBSD.org](mailto:bz@FreeBSD.org)\>

该项目的基本思想是实现将日志文件安全可靠地传输到远程主机。尽管实现主要集中在审计日志，但目标是构建可以为任何应用程序提供分布式日志记录的工具，通过使用简单的 API 并与共享库链接。

### 待办事项：

1. 网络协议实现
2. 缓冲区
3. SSL 支持

---

## [finstall](https://www.freebsd.org/status/report-2007-04-2007-06.html#finstall)

| 链接 |
| ------- |
|       |

联系方式：Ivan Voras \<[ivoras@FreeBSD.org](mailto:ivoras@FreeBSD.org)\>

`finstall` 项目旨在创建一个下一代的 FreeBSD 安装程序，利用系统中最新的功能。该项目应该在 7.0-RELEASE 中提供可用版本，但目的是将其作为 "第二" 安装程序系统，与 sysinstall 一起使用，在 7.x 版本期间提供支持。无论如何，sysinstall 将继续支持 finstall 不支持的架构（例如，所有除 i386 和 amd64 之外的架构）。

### 待办事项：

1. 工作进展顺利，按照计划进行。目前在 X11 应用程序执行只读文件系统时遇到了一些小问题（至少这是当前可识别的症状）。
2. 欢迎所有感兴趣的测试人员参加！

## [FreeBSD-update 前端](https://www.freebsd.org/status/report-2007-04-2007-06.html#FreeBSD-update-front-end)

| 链接 |
| ------- |
|       |

联系方式：Andrew Turner \<[andrew@FreeBSD.org](mailto:andrew@FreeBSD.org)\>

该项目分为前端和后端，前端与用户交互，后端与 freebsd-update 交互。前端和后端可以使用 XML 协议进行通信。GUI 几乎已经可以接收用户命令并将其发送给后端。后端能够检测到更新何时准备好。

---

## [Gvinum 改进](https://www.freebsd.org/status/report-2007-04-2007-06.html#Gvinum-improvements)

| 链接 |
| ------- |
| [我的 SoC 工作补丁](http://folk.ntnu.no/lulf/patches/freebsd/gvinum/soc2007 "http://folk.ntnu.no/lulf/patches/freebsd/gvinum/soc2007")      |
| [博客](http://blogs.freebsdish.org/lulf/ "http://blogs.freebsdish.org/lulf/")      |
| [Wiki 页面](http://wiki.freebsd.org/UlfLilleengen/SOC "http://wiki.freebsd.org/UlfLilleengen/SOC")      |

联系方式：Ulf Lilleengen \<[lulf@FreeBSD.org](mailto:lulf@FreeBSD.org)\>

我之前的状态报告包含了大量更新 gvinum 以支持旧 vinum 特性的代码。

今年 gvinum 已经进行了显著的重写。Lukas Ertl 开始重写 gvinum 的组织方式，从使用多消费者/提供者模型，改为使用单一消费者和提供者，并采用一个事件系统，首先处理用户请求，然后执行正常的 I/O 操作（类似于其他 GEOM 类）。这使得代码更易于阅读，也许还会减少一些 bug :)

1. 支持 plexes 和 volumes 的 setstate 操作。
2. attach/detach 命令现在可以正常工作。
3. concat/stripe/mirror 命令。之前的代码与新 gvinum 系统发生了更多冲突，但现在应该能正常工作。
4. （挂载状态下）支持重建。
5. （挂载状态下）支持同步。
6. 对旧代码进行了重构（基本上是更新旧代码以使用新的事件系统，并在可能的地方添加一些抽象）。

当然，还有一些时间花在了思考如何完成任务并修复其他 bug。我希望一些人对尝试这个项目感兴趣（所有工作目前都在 perforce 上），可以在 URL 部分找到补丁。这是一个实验性的项目，尽管我已做了大量测试来追踪 bug，但可能仍然存在一些 bug。

我今年夏天还有其他目标。然而，由于 gvinum 的一些部分已被重写，我可能无法完成所有目标，但目前已经开始支持连接卷的扩展（以及镜像卷）。我还希望实现 Raid5 数组的扩展。此外，记录 plexes 也是一个很酷的功能，但实际上并不需要，因为我们已经有了 g_journal。以上两个功能将在确保 gvinum 完全支持旧版 vinum 功能后进行处理，甚至可能做得更好。由于今年夏天可能有些额外时间，因此我非常欢迎大家提出建议，看看还有什么其他功能可以在这个过程中修复或实现。

### 待办事项：

1. 稳定性，稳定性，稳定性。我希望 gvinum 能非常稳定。为此，我有几台测试机器，将在这些机器上进行不同的测试。我已经制定了一个小的测试计划，并将使用它。
2. 创建一个 gvinumadmin 工具，使 gvinum 对新手用户更加友好。也许可以将其集成到安装程序中。这应该是我在最后做的工作，等一切都正常工作后进行 :) 可能会向 Ivan Voras 请教一下。
3. 更好地记录 gvinum 及其与 vinum 的区别。我已经做了记录，哪些地方需要文档化，这个任务正在进行中。
4. 实现卷的扩展和缩小功能。
5. 实现 plexes 的日志记录。记录所有写入的奇偶校验数据。


## [PXE 的 HTTP 支持](https://www.freebsd.org/status/report-2007-04-2007-06.html#http-support-for-PXE)

| 链接 |
| ------- |
| [项目代码库](http://perforce.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/soc2007/taleks-pxe_http "http://perforce.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/soc2007/taleks-pxe_http")      |
| [与项目相关的 Wiki 页面](http://wiki.freebsd.org/http_support_for_PXE "http://wiki.freebsd.org/http_support_for_PXE")      |

联系方式：Alexey Tarasov \<[taleks@FreeBSD.org](mailto:taleks@FreeBSD.org)\>

该项目的主要目标是在 PXE 预启动环境中引入代码，能够通过直接连接或 HTTP 代理从 Web 服务器下载，并准备启动 FreeBSD 内核。

已经实现但尚未彻底测试的功能包括：PXE 包装器核心代码、ARP、ICMP 回显请求/回复、类似常见套接字的套接字代码（UDP 和 TCP 模块）。基于套接字：简单的 DHCP 客户端、DNS 客户端。

目前正在开发 HTTP 客户端、TCP 测试、内核启动和项目模块的主要概念文档。

### 待办事项：

1. 测试不同 PXE 实现中的 PXE API 相关代码。
2. 测试已实现的协议。

---

## [Linuxulator 更新](https://www.freebsd.org/status/report-2007-04-2007-06.html#Linuxulator-update)

| 链接 |
| ------- |
| [Linuxulator 更新 2007](http://wiki.freebsd.org/linux-soc2007 "http://wiki.freebsd.org/linux-soc2007")      |

联系方式：Roman Divacky \<[rdivacky@FreeBSD.org](mailto:rdivacky@FreeBSD.org)\>
联系方式：Konstantin Belousov \<[kib@FreeBSD.org](mailto:kib@FreeBSD.org)\>

和去年一样，我有机会更新 Linuxulator 到 Linux 2.6 版本。今年我专注于完成 futex、\*at 系统调用和 epoll/inotify。

我与 Konstantin Belousov 合作，成功修复了 futex，达到了通过官方 futex 测试程序的状态。该修复已经提交，7.0R 将发布时包含正确的 futex 实现。计划工作包括从 futex 中移除 Giant 锁定，这只需要一些仔细的审查和测试。

最近，我主要关注 \*at 系统调用，补丁几乎完成，可以提交，我希望它能被包含进 7.0R 中。作为这项工作的组成部分，我还实现了原生的 FreeBSD 系统调用。请关注架构邮件列表，我将发布补丁。

我还完成了我的硕士论文，描述了 Linuxulator 的工作原理，Gábor Kévesdán 正在将其整合进官方的 FreeBSD 文档中。

在 epoll/inotify 领域尚未进行任何工作，但我希望在完成 \*at 系统调用后立即开始工作。

### 待办事项：

1. 完成 \*at 系统调用。
2. 开始 epoll/inotify 工作。
3. 完成从 futex 中移除 Giant 锁定。

---

## [lockmgr 重写](https://www.freebsd.org/status/report-2007-04-2007-06.html#lockmgr-rewriting)

| 链接 |
| ------- |
| [http://wiki.freebsd.org/AttilioRao](http://wiki.freebsd.org/AttilioRao "http://wiki.freebsd.org/AttilioRao")      |

联系方式：Attilio Rao \<[attilio@FreeBSD.org](mailto:attilio@FreeBSD.org)\>
联系方式：Jeff Roberson \<[jeff@FreeBSD.org](mailto:jeff@FreeBSD.org)\>

该项目旨在重写 lockmgr(9) 接口，采用更轻量的方式，使用原子指令和直接使用 sleepqueue 接口。这将导致更快的原语、更合理的接口和更高的代码可维护性。

到目前为止，已经创建了三个新文件：kern/kern_lockng.c、sys/_lockmgrng.h 和 sys/lockmgrng.h，作为新原语的基础，并且初步实现已经提交到 perforce 分支：//depot/user/attilio/attilio_lockmgr/...

该实现包含了一套良好的代码，旨在替代旧版 lockmgr。实际上，它只缺少对锁定排空的支持，这将在初步测试阶段之后以及更好的唤醒算法引入后提交（这将大大简化排空过程并提高唤醒性能）。

### 待办事项：

1. 需要一些测试

---

## [mtund - 魔术隧道守护进程](https://www.freebsd.org/status/report-2007-04-2007-06.html#mtund---Magic-Tunnel-Daemon)

| 链接 |
| ------- |
| [mtund Wiki 页面](http://wiki.freebsd.org/SuperTunnelDaemon "http://wiki.freebsd.org/SuperTunnelDaemon")      |

联系方式：Matus Harvan \<[mharvan@FreeBSD.org](mailto:mharvan@FreeBSD.org)\>

IP 可以通过多种网络协议在不同层次进行隧道传输，如 IP、ICMP、UDP、TCP、DNS、HTTP、SSH。虽然由于防火墙的存在，直接连接可能不可行，但 IP 数据包可以作为有效载荷封装在其他协议中，从而能够穿越防火墙。然而，每种封装都需要设置不同的程序，用户需要手动尝试不同的封装方式，找出哪些方式在特定环境中可行。

mtund 是一个使用运行时可加载插件的隧道守护进程，能够在每种环境中自动选择最佳的封装方式，并在环境变化时切换到另一种封装方式。目前已有运行代码，能够通过 TCP 和 UDP 进行隧道传输，并且具备有效的故障转移机制。由于这是一个 Google Summer of Code 项目，可以预期在夏季期间会有快速的更改和新功能的增加。请查看 Wiki 页面以获取更多详细信息和最新进展。

请注意，该项目最初以 "Super Tunnel Daemon" 为名，但后来更名为 mtund，即魔术隧道守护进程。

### 待办事项：

1. 我始终欢迎大家尝试代码并提供反馈，无论是正面的还是负面的。

## [多播 DNS 和服务发现](https://www.freebsd.org/status/report-2007-04-2007-06.html#Multicast-DNS-and-Service-Discovery)

| 链接 |
| ------- |
|       |

联系方式：Fredrik Lindberg \<[fli@FreeBSD.org](mailto:fli@FreeBSD.org)\>

该项目旨在为基础系统创建一个多播 DNS 守护进程和服务发现工具。多播 DNS 是零配置网络（Zeroconf）的一部分，提供通过 DNS 类似的名称来寻址主机的能力，无需现有的（单播）管理 DNS 服务器。响应守护进程的工作已经进展良好，唯一缺失的大块是让本地客户端能够执行查询。代码可以在 p4 分支 projects/soc2007/fli-mdns_sd 中找到，即使它尚不完整，任何人都可以试试看。项目计划可以在 Wiki 上找到。

---

## [将 Linux KVM 移植到 FreeBSD](https://www.freebsd.org/status/report-2007-04-2007-06.html#Porting-Linux-KVM-to-FreeBSD)

| 链接 |
| ------- |
|       |

联系方式：Fabio Checconi \<[fabio@FreeBSD.org](mailto:fabio@FreeBSD.org)\>
联系方式：Luigi Rizzo \<[luigi@FreeBSD.org](mailto:luigi@FreeBSD.org)\>

Linux 基于内核的虚拟机（KVM）是一种利用一些现代 CPU 中的虚拟化扩展（例如，Intel VT 和 AMD-V）进行虚拟化的机制。虚拟化扩展允许普通进程以接近本地速度受控地执行一部分特权指令。这样可以提高系统仿真器（如 qemu、xen、vmware、vkernel、用户模式 Linux（UML）等）的性能。

该项目的目的是将 Linux KVM 移植到 FreeBSD，实现为一个可加载的模块 lkvm.ko。我们使用 ports/devel/linux-kmod-compat 中的方法，几乎不修改原始的 Linux 源代码。我们还将移植一个修改过的 qemu 版本，利用 Linux KVM 提供的功能来加速仿真。

上面的 URL 链接到进度报告，详细说明了项目目标、已完成的里程碑以及提交日志的细节。

截至 2007 年 6 月底，我们主要扩展了 linux-kmod-compat，以支持 Linux KVM 代码使用的内核 API。所需的功能已经以不同程度实现，从简单的存根到完全功能的实现。我们还导入了修改过的 qemu 以及用于构建 Linux KVM 用户空间客户端的库。在 SoC 项目的后半部分，我们计划完成内核 API 的实现，并拥有一个完全功能的 Linux KVM 模块以及它的客户端（qemu）。

---

## [将 OpenBSD 的 sysctl 硬件传感器框架移植到 FreeBSD](https://www.freebsd.org/status/report-2007-04-2007-06.html#Porting-OpenBSD's-sysctl-Hardware-Sensors-Framework-to-FreeBSD)

| 链接 |
| ------- |
| [将 OpenBSD 的 sysctl hw.sensors 框架移植到 FreeBSD，GSoC2007 原始提案](http://mojo.ru/us/GSoC2007.FreeBSD.cnst-sensors.proposal.html "http://mojo.ru/us/GSoC2007.FreeBSD.cnst-sensors.proposal.html")      |
| [cnst 的 GSoC2007 博客](http://cnst.livejournal.com/tag/GSoC2007 "http://cnst.livejournal.com/tag/GSoC2007")      |
| [cnst 的 GSoC2007 atom feed](http://cnst.livejournal.com/data/atom?tag=GSoC2007 "http://cnst.livejournal.com/data/atom?tag=GSoC2007")      |
| [在 perforce 中的 cnst-sensors in soc2007](http://perforce.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/soc2007/cnst-sensors/ "http://perforce.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/soc2007/cnst-sensors/")      |

联系方式：Constantine A. Murenin \<[cnst@FreeBSD.org](mailto:cnst@FreeBSD.org)\>
联系方式：Shteryana Shopova \<[syrinx@FreeBSD.org](mailto:syrinx@FreeBSD.org)\>

自 2003 年以来，OpenBSD 就包含了 sysctl hw.sensors 框架；自 2005 年以来，该框架支持 RAID 驱动和大多数已知的 i2c 传感器；自 2006 年以来，框架重新设计，引入了传感器设备的概念，以适应持续增长。该框架包括内核 API、sysctl(3)/sysctl(8)、sensorsd(8)、ntpd(8)、systat(1)、ports/sysutils/symon 和 51 个驱动程序，截至 2007 年 7 月 7 日。

此 GSoC2007 项目旨在将这个统一的硬件监控接口的基础部分移植到 FreeBSD。虽然由于架构差异，无法移植所有驱动程序，但我们计划移植框架的所有其他部分和相关的用户空间工具。

目前，lm(4) 在 isa 上和一些内核 API 已经被移植。接下来的重要步骤是完成 sysctl(3) 的连接代码，以便完成用户空间工具的移植工作。关于 sysctl 的详细讨论正在 arch@ 邮件列表上进行。

### 待办事项：

1. 完成 sysctl(3) 连接代码

## [Ports 集合基础设施改进](https://www.freebsd.org/status/report-2007-04-2007-06.html#Ports-Collection-infrastructure-improvements)

| 链接 |
| ------- |
| [Gábor 的 SoC 2007 Wiki 页面](http://wiki.freebsd.org/G%C3%A1borSoC2007 "http://wiki.freebsd.org/G%C3%A1borSoC2007")      |

联系方式：Gábor Kévesdén \<[gabor@FreeBSD.org](mailto:gabor@FreeBSD.org)\>
联系方式：Andrew Pantyukhin \<[sat@FreeBSD.org](mailto:sat@FreeBSD.org)\>

Gábor Kévesdén 正在为 Ports 集合基础设施进行一些改进。今年，他旨在解决长期存在的问题，这些问题在 GNATS 中进行跟踪，但最近没有志愿者参与。通过 Andrew Pantyukhin 的指导，他还以更实际的方式重新实现了 Ports 集合的 DESTDIR 支持。该项目的完整描述和状态可以在 Gábor 的 SoC 2007 Wiki 页面上找到。

### 待办事项：

1. 请查看 Wiki 页面以获取当前状态。

---

## [安全回归测试](https://www.freebsd.org/status/report-2007-04-2007-06.html#Security-Regression-Test)

| 链接 |
| ------- |
| [Perforce 仓库](http://perforce.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/soc2007/zhouzhouyi%5fmactest%5fsoc "http://perforce.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/soc2007/zhouzhouyi%5fmactest%5fsoc")      |

联系方式：Zhouyi Zhou \<[zhouzhouyi@FreeBSD.org](mailto:zhouzhouyi@FreeBSD.org)\>
联系方式：Robert Watson \<[rwatson@FreeBSD.org](mailto:rwatson@FreeBSD.org)\>

安全回归测试是由 2007 年 Google 夏季编码项目支持的。该阶段的主要目标是测试 FreeBSD 强制访问控制框架的正确性，包括正确地将安全标签从用户空间传递到内核以及强制访问控制钩子的不可绕过性。

过去一个月的工作：

1. 构建了一对用于测试网络相关钩子的伪以太网驱动程序。为了避免数据包通过 lo 接口，驱动程序中扭曲了数据包中的 IP 地址。
2. 构建了一个框架，用于记录在一段时间内调用的强制访问控制钩子。

    * 在内核中，每个非空标签被转换为可读的字符串，并与调用的钩子的名称以及可能的标志或模式（例如，mac_check_vnode_open 钩子的 VREAD/VWRITE）一起记录在尾队列中。有一个线程类似于审计子系统的 audit_worker，负责将队列记录到用户空间文件中。用户空间程序使用 open、ioctl 和 close 操作 /dev/mactest 节点来触发和停止日志记录。每次触发日志记录机制时，日志文件都会被截断为零。
    * 在用户空间，使用基于 bison 的解析工具解析日志文件，并重构记录链，与测试套件提供的配置文件进行比较，以检查是否调用了预期的钩子以及标签/标志/模式是否正确。测试套件主要遵循 src/tools/regression/fstest，已修改以适应测试强制访问控制框架并包括对信号的测试。

### 待办事项：

1. 代码较为简陋。例如，vn_open 的调用未检查其返回值，缺乏容错性。代码风格也需要修改。
2. 尽管测试框架已完全构建，但仍需编写详细的测试用例，除了 fstest 和信号外，还需要添加其他测试用例。
3. 审计子系统的测试尚未开始。
4. FreeBSD 中的安全子系统其他部分也需要关注。

---

## [tarfs：一个 tar 文件系统](https://www.freebsd.org/status/report-2007-04-2007-06.html#tarfs:-A-tar-File-System)

| 链接 |
| ------- |
| [TarFS Wiki](http://www.googlebit.com/doku.php?id=tarfs "http://www.googlebit.com/doku.php?id=tarfs")      |

联系方式：Eric Anderson \<[anderson@FreeBSD.org](mailto:anderson@FreeBSD.org)\>

Tarfs 是 FreeBSD 的一个简单的 tar 文件系统实现。

当前目标包括：

* 支持所有标准的只读操作
* 支持大容量 tar 文件（几 GB）
* 使用最小的内存
* 允许将 tar 文件作为根文件系统使用
* 足够快以实际使用

当前状态：

* 可以挂载大多数 tar 文件
* 可以执行大多数操作（open, lookup, stat, readdir 等）
* 支持大容量 tar 文件（已测试最大 2GB）
* 使用相对较少的内存 —— 与文件/目录的数量成正比

### 待办事项：

1. 挂载的 tar 文件系统根目录中没有 `..` 目录
2. 关于根目录外子目录中 `..` 的锁定问题
3. 不支持块/字符特殊设备。需要吗？
4. 需要一种目录哈希方法
5. 需要更多的测试

# [项目](https://www.freebsd.org/status/report-2007-04-2007-06.html#Projects)

## [FreeBSD/xen](https://www.freebsd.org/status/report-2007-04-2007-06.html#FreeBSD/xen)

| 链接 |
| ------- |

联系方式：Rink Springer \<[rink@FreeBSD.org](mailto:rink@FreeBSD.org)\>

FreeBSD/xen 移植工作正在顺利进行，目标是完成 Kip Macy 的 FreeBSD/xen 移植，并使其符合 7.0 版本的要求。

通常，移植已经很稳定，性能也相当不错。主要瓶颈是无法与 GCC 4.2 配合使用，这是提交之前的最后一个大任务。

### 待办事项：

1. 修复移植，使其能够正确与 GCC 4.2 配合使用。
2. 将 Xen 驱动移植到 newbus。
3. 测试/修复 PAE 支持。
4. 开始支持 amd64。

---

## [HDTV 驱动（ATSC）](https://www.freebsd.org/status/report-2007-04-2007-06.html#HDTV-Drivers-(ATSC))

| 链接 |
| ------- |
| [bktrau Perforce 源代码仓库](http://perforce.freebsd.org/fileSearch.cgi?FSPC=%2F%2Fdepot%2Fuser%2Fjmg%2Fbktrau%2F...&ignore=GO%21 "http://perforce.freebsd.org/fileSearch.cgi?FSPC=%2F%2Fdepot%2Fuser%2Fjmg%2Fbktrau%2F...&ignore=GO%21")      |
| [cxd Perforce 源代码仓库](http://perforce.freebsd.org/fileSearch.cgi?FSPC=%2F%2Fdepot%2Fuser%2Fjmg%2Fcxd%2F...&ignore=GO%21 "http://perforce.freebsd.org/fileSearch.cgi?FSPC=%2F%2Fdepot%2Fuser%2Fjmg%2Fcxd%2F...&ignore=GO%21")      |

联系方式：John-Mark Gurney \<[jmg@FreeBSD.org](mailto:jmg@FreeBSD.org)\>

此条目之前是 Bt878 音频驱动（即 FusionHDTV 5 Lite 驱动）的公告，但随着工作略微扩展，现在它变得更加通用。

自 1 月以来，bktrau 中修复了一些 bug。如果您正在使用早期版本，建议升级，因为该驱动程序可能会导致 panic。该驱动程序支持在同一台机器上使用多个卡（已测试两张卡）。

**FusionHDTV 5 Lite** —— 由于 DViCO 和 LG 缺乏文档，我从 Linux 驱动程序中复制了魔法值，以使 ATSC 捕捉工作。

**ATI HDTV Wonder** —— 在多年尝试加入 ATI 开发者计划后，他们终于暂停了该计划，因此无法获得 ATI 的支持。我已开始为 Conexant CX2388x 基础的卡片开发一个名为 cxd 的驱动程序。ATI HDTV Wonder 使用 ATI 自己的解调器，我在借鉴 Linux 驱动的基础上让它能够调谐。捕捉时，我得到了有效数据，但并不是所有数据。由于 ATI 和 linux-dvb 缺乏支持，该项目已经无限期搁置。

如果有人有其他基于 CX2388x 的卡片，应该不难将该驱动程序移植到其他调谐器上。

对于这两款驱动/卡，提供了一个 Python 模块，并且提供了一个使用它的示例捕获应用程序。现在该模块已知在多线程环境下运行良好，这样调谐（由于 i2c ioctl 的开销）就可以在另一个线程中进行，而不会导致程序变慢。该模块与自定义 PVR 后端一起工作良好。

### 待办事项：

1. 提供对 NTSC 和 FM 调谐的支持。
2. 为其他使用 Bt878 芯片的卡和调谐器添加支持。
3. 为其他使用 CX2388x 芯片的卡和调谐器添加支持。

---

## [使用 MySQL 减少内核争用](https://www.freebsd.org/status/report-2007-04-2007-06.html#Kernel-contention-reduction-using-mysql)

| 链接 |
| ------- |
| [MySQL 基准测试和讨论](http://jeffr-tech.livejournal.com/ "http://jeffr-tech.livejournal.com/")      |

联系方式：Jeff Roberson \<[jeff@FreeBSD.org](mailto:jeff@FreeBSD.org)\>

FreeBSD 开发人员一直在使用 MySQL 作为测试平台，以查找内核中的争用热点。通过这一工作，我们已经看到，在 8 路机器上，相较于 6.0，性能提高了 5 倍。最近的更改包括在 fcntl() 中进行更细粒度的锁定，移除 Giant 在 flock 和 fcntl F_SETLK 中的使用。这些更改将在 7.0 中提供，主要提高写入性能。关于 select() 的实验性更改也已在 arch@ 中讨论，旨在解决那里的争用问题，但这些更改在 7.0 时间框架内不会准备好。

## [在 PMCTools 中捕获堆栈跟踪](https://www.freebsd.org/status/report-2007-04-2007-06.html#Stack-trace-capture-in-PMCTools)

| 链接 |
| ------- |
| [PMCTools Wiki 页面](http://wiki.freebsd.org/PmcTools "http://wiki.freebsd.org/PmcTools")      |

联系方式：Joseph Koshy \<[jkoshy@FreeBSD.org](mailto:jkoshy@FreeBSD.org)\>

内核/hwpmc(4) 部分的堆栈跟踪捕获已经实现，并在 Perforce 中的路径 '//depot/user/jkoshy/projects/pmc/...' 下提供。我目前正在增强 pmcstat(8)，以提取并总结这些信息。感谢 Google Inc. 对这个项目的支持。

---

## [TrustedBSD 审计](https://www.freebsd.org/status/report-2007-04-2007-06.html#TrustedBSD-Audit)

| 链接 |
| ------- |
| [TrustedBSD 审计页面](http://www.trustedbsd.org/audit.html "http://www.TrustedBSD.org/audit.html")      |

联系方式：Robert Watson \<[rwatson@FreeBSD.org](mailto:rwatson@FreeBSD.org)\>  
联系方式：Christian Peron \<[csjp@FreeBSD.org](mailto:csjp@FreeBSD.org)\>  
联系方式：\<[trustedbsd-audit@TrustedBSD.org](mailto:trustedbsd-audit@TrustedBSD.org)\>

为 7.0 做准备的一般清理工作。

进程审计状态已移到凭证中，以便在大多数情况下可以无锁访问，并允许在异步上下文中使用。

已导入 OpenBSM 1.0a14，解决了 IPv6 字节序问题，清除了 OpenBSM 在 gcc41 中的警告，向 audit_submit(3) 添加了 getaudit_addr()，添加了 zonename 标记；自从之前导入的 CVS 1.0a12 版本以来，还进行了其他更改，包括手册页改进、XML 打印支持、更好的 audit.log.5 文档、额外的 64 位标记类型和新的审计事件标识符。

已添加 MAC 检查，以便 MAC 策略可以控制审计系统调用的使用。

现在审计还提供了一个 security.audit sysctl 节点，用于确定是否已编译审计支持；启动时的控制台打印已被移除。

“options AUDIT”现在已经包含在 7-CURRENT GENERIC 内核中，因此 AUDIT 支持将在 7.0 中开箱即用，无需重新编译内核。仍然需要在 rc.conf 中手动启用审计支持。随着 FreeBSD 7.0 的发布，AUDIT 将是一个完全支持的功能，而不是实验性功能。

---

## [TrustedBSD MAC 框架](https://www.freebsd.org/status/report-2007-04-2007-06.html#TrustedBSD-MAC-Framework)

| 链接 |
| ------- |
| [TrustedBSD MAC 页面](http://www.trustedbsd.org/mac.html "http://www.TrustedBSD.org/mac.html")      |

联系方式：Robert Watson \<[rwatson@FreeBSD.org](mailto:rwatson@FreeBSD.org)\>  
联系方式：\<[trustedbsd-discuss@TrustedBSD.org](mailto:trustedbsd-discuss@TrustedBSD.org)\>

清理 MAC 框架的 API/KPI 层：mac.h 现在仅为用户和用户<->内核 API；mac_framework.h 是内核<->MAC 框架 KPI，mac_policy.h 是 MAC 框架<->MAC 策略模块 KPI。类似地，mac_label_get() 和 mac_label_set() 访问函数现在允许策略访问标签数据，而不需要将 struct label 的二进制布局编码到策略模块中，这为更高效的布局开辟了空间。struct label 现在位于 mac_internal.h 中，仅在 MAC 框架内部使用。

进行了常规的 MAC 策略清理，包括删除一些示例策略的无操作入口点和 sysctls。mac_test(4) 已大幅清理，所有入口点添加了计数器。

已添加 UNIX 域套接字连接的 MAC 检查。

已添加 MAC 检查，以便 MAC 策略可以控制审计系统调用的使用。

已移除重复现有特权但没有提供附加上下文的 MAC 检查（如 sysarch_ioperm、kld_unload、settime 和 system_nfsd）——与特权对齐的检查，但提供附加上下文（例如附加参数）的检查被保留。

Biba 和 LOMAC 策略现在实现了 priv(9) 检查，区分可能会危及系统完整性模型的特权和不会危及的特权。

几乎未使用的 mnt_fslabel / mnt_label 区别已经通过移至单一 mnt_label 进行消除。此更改对任何策略没有功能性影响。

为同步与 Mac OS X Leopard 中采用的 MAC 框架版本的命名约定，已经修改了几个与 MAC 相关的接口；还有更多重要的更改正在进行，以完成这种同步。虽然在没有仔细考虑和修改的情况下，不可能在两个平台之间复用策略，但这将使移植变得更加容易。

## [USB](https://www.freebsd.org/status/report-2007-04-2007-06.html#USB)

| 链接 |
| ------- |
| [当前 USB 文件](http://perforce.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/usb/src/sys/dev/usb&HIDEDEL=NO "http://perforce.freebsd.org/depotTreeBrowser.cgi?FSPC=//depot/projects/usb/src/sys/dev/usb&HIDEDEL=NO")      |
| [我的 USB 主页](http://www.turbocat.net/~hselasky/usb4bsd "http://www.turbocat.net/~hselasky/usb4bsd")      |
| [新 USB 堆栈和 USB 设备驱动程序的代码参考](http://www.turbocat.net/~hselasky/usb4bsd/dev_new_usb.pdf "http://www.turbocat.net/~hselasky/usb4bsd/dev_new_usb.pdf")      |

联系方式：Hans Petter Sirevaag Selasky \<[hselasky@FreeBSD.org](mailto:hselasky@FreeBSD.org)\>

在过去三个月中，USB 堆栈发生了若干变化。以下是最重要的变化概述：

1. 现在完全支持通过高速 USB 集线器连接的全速异步设备。由于各种原因，最大异步带宽被限制为 6MBit/s。此限制是可调的。
2. 现在通过 Linux USB API 模拟层，完全支持 Linux USB 设备驱动程序。
3. 进行了各种清理和修复。

Markus Brueffer 仍在继续工作 USB HID 解析器和支持。目前尚未提交任何更改。

如果您想测试新的 USB 堆栈，可以查看 USB 的 Perforce 树或从我的 USB 主页下载 USB 驱动程序的 SVN 版本。目前 tarballs 可能有些过时。

有关新 USB API 的想法和意见，欢迎通过 freebsd-usb@FreeBSD.org 提供反馈。

---

## [USB 更新](https://www.freebsd.org/status/report-2007-04-2007-06.html#USB-update)

| 链接 |
| ------- |

联系方式：Warner Losh \<[imp@FreeBSD.org](mailto:imp@FreeBSD.org)\>

大约 18 个月前，我开始删除 USB 堆栈中的兼容性宏。这些宏使代码阅读非常困难，也很难诊断问题。它们构成了进入堆栈并理解代码的障碍。此外，许多宏实际上隐藏了除最深入的代码调查外的错误。

我已经删除了客户端驱动程序中的几乎所有宏，并删除了 FreeBSD USB 堆栈核心中所有宏的实例。这使得驱动程序更加易读，并且更加健壮。在此过程中，我修复了许多小错误，包括一些人们没有报告的问题。我还根据用户 PR 以及来自 OpenBSD/NetBSD 驱动程序的反馈，添加了大量的新厂商和产品 ID。

我完成了这项工作，以便 FreeBSD USB 堆栈在 RELENG_7 期间更容易维护。我计划在这些更改经过 Current 测试后，将它们大多数 MFC 到 RELENG_6 中。这项工作中只有一个 API 更改，因此这是可行的，并且使得在 6.x 和 7.x 之间共享驱动程序变得更加容易。目前还不清楚 RELENG_6 会存在多久，所以我希望这能使得 6.3 版本的 USB 得到改进，如果这是人们选择的发布版本。

我避免了对堆栈进行许多更复杂的更改。Hans Petter Selasky (hps) 在树外进行了这些更改的工作。他的堆栈中有很多已经准备好合并的部分，我希望能从他的工作中整合出一些有用的部分，而不造成对 FreeBSD USB 堆栈的干扰。

我也在寻找其他 FreeBSD 开发人员加入并帮助工作。我所做的几乎所有改进，都是通过每周花费几个小时浏览 PR 以处理一些非常简单的工作来完成的。其他人也有很多机会参与改进 FreeBSD 的 USB 堆栈，同时也有机会将 hps USB 堆栈中的有用部分导入进来，最终减少它与当前 FreeBSD USB 堆栈之间的差异。此外，我还在寻找能够从 DragonFlyBSD 进行类似设备 ID 合并的人。

最后，我开始了一项任务，尝试合并所有 BSD 的 usbdevs 文件。没有理由将它们分开。我已经开始修改 usbdevs(1) 以读取 src/sys/dev/usb/usbdevs 文件，并通过这种方式报告更详细的信息。合并后的 usbdevs 将更大，并且在 USBVERBOSE 内核中占用更多内存，因此为了缓解这一影响，我正在对 usbdevs(1) 进行一些更改。

### 待办事项：

1. 在 7.0 发布之前，最大的关注点是将更新的设备列表纳入手册页。这个任务对我来说太庞大，无法与我目前清理工作的任务一起完成。
2. 我们需要更多愿意帮助“琐碎” PR 的人，这些 PR 主要是向驱动程序添加 ID。此外，我们还需要定期将我们的驱动程序列表与 DragonFlyBSD、NetBSD 和 OpenBSD 的驱动程序同步。
3. 合并其他 BSD 的 usbdevs 表将非常有帮助。
4. 为 usbdevs(1) 编写一个 usbdevs 解析器。
